name: CI/CD Docker App

# Este workflow se activa solo cuando se hace push desde ramas sprint-* hacia develop
on:
  push:
    branches: ['develop', 'main']
  pull_request:
    branches: ['develop', 'main']
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && startsWith(github.head_ref, 'sprint-') || (github.event_name == 'push' && github.ref == 'refs/heads/develop') || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: password
          POSTGRES_DB: python_learning_platform
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout código
      uses: actions/checkout@v3

    - name: Configurar entorno
      run: echo "Configurando entorno para ${{ github.ref }}"

    - name: Verificar versión de Docker
      run: docker --version

    - name: Instalar Docker Compose
      run: |
        sudo curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
        sudo chmod +x /usr/local/bin/docker-compose
        docker-compose --version

    - name: Configurar Docker
      run: |
        docker-compose -f docker-compose.yml up --build --no-cache -d
        docker-compose ps
        docker-compose logs backend

    - name: Esperar a PostgreSQL
      run: |
        for i in {1..10}; do
          if docker-compose exec db pg_isready -U user; then
            echo "PostgreSQL está listo"
            exit 0
          fi
          sleep 5
        done
        echo "PostgreSQL no respondió"
        exit 1

    - name: Esperar a que el backend responda
      run: |
        echo "Esperando a que el backend esté listo..."
        for i in {1..10}; do
          if curl -s -f http://localhost:5000/api/test/message; then
            echo "¡Backend respondió correctamente!"
            exit 0
          fi
          echo "Intento $i/10 - Backend no disponible aún..."
          docker-compose logs backend --tail=20  # Muestra últimos logs
          sleep 10
        done
        echo "ERROR: Backend no respondió después de 100 segundos"
        docker-compose logs backend  # Muestra todos los logs antes de fallar
        exit 1

    - name: Verificar frontend
      run: |
        curl -f http://localhost:5173 || echo "Frontend iniciado pero sin pruebas definidas"

    - name: Detener los contenedores después de las pruebas
      run: docker-compose down
